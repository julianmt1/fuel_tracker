<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuel Usage Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --primary-hover: #059669;
            --primary-light: #d1fae5;
            --bg-page: #f8fafc;
            --bg-card: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.8);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --text-light: #f1f5f9;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
            --shadow-colored: 0 10px 15px -3px rgba(16, 185, 129, 0.2);
            --radius-md: 1rem;
            --radius-lg: 1.5rem;
            --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
        }

        [data-theme="dark"] {
            --primary: #34d399;
            --primary-hover: #10b981;
            --primary-light: rgba(52, 211, 153, 0.15);
            --bg-page: #0f172a;
            --bg-card: #1e293b;
            --bg-glass: rgba(30, 41, 59, 0.8);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --text-light: #1e293b;
            --border: #334155;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
            --shadow-colored: 0 10px 15px -3px rgba(52, 211, 153, 0.15);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-page);
            color: var(--text-main);
            margin: 0;
            padding: 2rem 1rem;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .app-container {
            max-width: 725px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        header {
            text-align: center;
            margin-bottom: 2.5rem;
            animation: fadeIn 0.8s ease-out;
        }

        header h1 {
            font-size: 2.25rem;
            font-weight: 800;
            margin: 0 0 0.5rem 0;
            letter-spacing: -0.05em;
            background: linear-gradient(135deg, var(--text-main) 0%, var(--primary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        header p {
            color: var(--text-muted);
            font-size: 1rem;
            margin: 0;
            font-weight: 500;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 1rem 0;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input,
        select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            color: var(--text-main);
            background-color: var(--bg-page);
            transition: all 0.2s;
            font-family: inherit;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-light);
            background-color: var(--bg-card);
        }

        .btn-primary {
            width: 100%;
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            box-shadow: var(--shadow-colored);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            width: 100%;
            background-color: var(--bg-card);
            color: var(--text-main);
            border: 1px solid var(--border);
            padding: 0.875rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-secondary:hover {
            background-color: var(--bg-page);
            border-color: var(--text-muted);
        }

        .btn-secondary:active {
            transform: scale(0.98);
        }

        /* Table */
        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            text-align: center;
            padding: 0.75rem 1rem;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            background-color: var(--bg-page);
            white-space: nowrap;
        }

        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
            white-space: nowrap;
        }

        .tc {
            text-align: center;
        }

        .tr {
            text-align: right;
        }

        .tl {
            text-align: left;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .empty-state td {
            text-align: center;
            color: var(--text-muted);
            padding: 2rem;
            font-style: italic;
            white-space: normal;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 0;
            }

            .card {
                padding: 1rem;
                border-radius: 0;
                margin-bottom: 0.5rem;
                box-shadow: none;
                border: none;
                border-bottom: 1px solid var(--border);
            }

            header {
                margin-bottom: 1.5rem;
                padding: 1rem 1rem 0 1rem;
                text-align: left;
            }

            header h1 {
                font-size: 1.75rem;
                margin-bottom: 0.25rem;
            }

            header p {
                font-size: 0.95rem;
            }

            .modal-content input,
            .modal-content select,
            .modal-content button {
                min-height: 50px;
                font-size: 16px;
            }

            .btn-icon {
                padding: 0.75rem;
            }

            .hide-mobile {
                display: none;
            }

            .chart-container {
                height: 250px;
            }

            .pagination-container {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .page-navigation {
                justify-content: space-between;
            }

            .page-navigation button {
                flex: 1;
            }
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background-color: var(--primary-light);
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-main);
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
            border: none;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .checkbox-col {
            width: 40px;
            text-align: center;
            display: none;
        }

        .checkbox-col.show {
            display: table-cell;
        }

        .action-col {
            width: 60px;
            text-align: center;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .edit-input {
            width: 100%;
            padding: 0.25rem 0.5rem;
            font-size: 0.9rem;
            border: 1px solid var(--primary);
            border-radius: 0.25rem;
            outline: none;
            font-family: inherit;
            background-color: #f0fdf4;
            min-height: unset;
        }

        .edit-input:focus {
            box-shadow: 0 0 0 2px var(--primary-light);
        }

        .editing-row {
            background-color: var(--bg-page);
        }

        .badge {
            padding: 0.2rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge.regular {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .badge.premium {
            background-color: #fae8ff;
            color: #86198f;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--primary);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0 0 0;
            border-top: 1px solid var(--border);
            margin-top: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .rows-per-page {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .rows-per-page select {
            width: auto;
            padding: 0.3rem 0.6rem;
            font-size: 0.9rem;
            min-height: unset;
        }

        .page-navigation {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--bg-card);
            width: 100%;
            max-width: 600px;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            padding: 2rem;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .modal-overlay.open .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin: 0;
        }

        @media (min-width: 600px) {
            .modal-overlay {
                align-items: center;
                padding: 2rem;
            }

            .modal-content {
                border-radius: var(--radius-lg);
                transform: scale(0.95);
                opacity: 0;
                margin: auto;
                transition: transform 0.3s, opacity 0.3s;
            }

            .modal-overlay.open .modal-content {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* FAB */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 101;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .fab:hover {
            transform: scale(1.08);
            background: var(--primary-hover);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Theme toggle */
        #themeToggle {
            background: none;
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: all 0.2s;
            position: absolute;
            top: 1.5rem;
            right: 1rem;
        }

        #themeToggle:hover {
            color: var(--primary);
            border-color: var(--primary);
        }

        .moon-icon {
            display: none;
        }
    </style>
</head>

<body>
    <button id="themeToggle" title="Toggle dark mode">
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>

    <div class="app-container">
        <header>
            <h1>Fuel Tracker</h1>
            <p>Monitor your efficiency and costs</p>
        </header>

        <main>
            <section class="card">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="history">History</button>
                    <button class="tab-btn" data-tab="analytics">Efficiency</button>
                </div>

                <div id="tab-history" class="tab-content active">
                    <div
                        style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem;">
                        <div style="display:flex;gap:0.5rem;">
                            <button type="button" id="downloadBtn" class="btn-sm" title="Download CSV">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                <span class="hide-mobile">CSV</span>
                            </button>
                            <button type="button" id="loadBtn" class="btn-sm" title="Load CSV">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                <span class="hide-mobile">Import</span>
                            </button>
                            <input type="file" id="csvInput" accept=".csv" style="display:none;">
                        </div>
                        <div id="actionButtons">
                            <button type="button" id="deleteModeBtn" class="btn-icon" title="Delete Entries">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" style="color:#ef4444;">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                </svg>
                            </button>
                            <div id="deleteActions" style="display:none;gap:0.5rem;">
                                <button type="button" id="confirmDeleteBtn" class="btn-sm btn-danger">Delete
                                    Selected</button>
                                <button type="button" id="cancelDeleteBtn" class="btn-sm">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-wrapper">
                        <table id="historyTable">
                            <thead>
                                <tr>
                                    <th class="checkbox-col">Select</th>
                                    <th>Date</th>
                                    <th>Mileage (km)</th>
                                    <th>Cost ($)</th>
                                    <th>Type</th>
                                    <th>Station</th>
                                    <th class="action-col">✎</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="empty-state">
                                    <td colspan="6">No entries yet. Tap + to add one!</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="pagination-container">
                        <div class="rows-per-page">
                            <label for="rowsPerPage">Rows:</label>
                            <select id="rowsPerPage">
                                <option value="5" selected>5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                        <div class="page-navigation">
                            <button id="prevPageBtn" class="btn-sm" disabled>Prev</button>
                            <span id="pageInfo">Page 1 of 1</span>
                            <button id="nextPageBtn" class="btn-sm" disabled>Next</button>
                        </div>
                    </div>
                </div>

                <div id="tab-analytics" class="tab-content">
                    <div class="chart-container">
                        <canvas id="efficiencyChart"></canvas>
                    </div>
                    <p style="text-align:center;color:var(--text-muted);font-size:0.9rem;margin-top:1rem;">
                        Efficiency = (Mileage / Cost) × 100 • X-Axis: Time • Labels: Station
                    </p>
                </div>
            </section>
        </main>
    </div>

    <!-- FAB -->
    <button class="fab" id="fabAdd" title="Add Entry">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>

    <!-- Entry Modal -->
    <div class="modal-overlay" id="entryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Entry</h2>
                <button id="closeModalBtn" class="btn-icon" title="Close">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <form id="fuelForm">
                <div class="form-group">
                    <label for="currentKm">Current Mileage (km)</label>
                    <input type="number" id="currentKm" required placeholder="e.g. 15000">
                </div>
                <div class="form-group">
                    <label for="fuelCost">Fuel Cost ($)</label>
                    <input type="number" id="fuelCost" step="1" min="0" required placeholder="e.g. 45">
                </div>
                <div class="form-group">
                    <label for="fuelType">Fuel Type</label>
                    <select id="fuelType" required>
                        <option value="" disabled selected>Select type</option>
                        <option value="Regular">Regular</option>
                        <option value="Premium">Premium</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="gasStation">Gas Station</label>
                    <input type="text" id="gasStation" required placeholder="e.g. Shell, Chevron">
                </div>
                <button type="submit" class="btn-primary">
                    <span>Save Entry</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        // --- Firebase Configuration ---
        // TODO: Replace the config below with your own Firebase project credentials
        // You can find these in Firebase Console -> Project Settings -> General -> Your Apps
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            onSnapshot,
            addDoc,
            doc,
            updateDoc,
            deleteDoc,
            query,
            orderBy,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        let db;
        let isFirebaseActive = false;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            isFirebaseActive = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('fuelForm');
            const historyTableBody = document.querySelector('#historyTable tbody');
            const inputs = {
                km: document.getElementById('currentKm'),
                cost: document.getElementById('fuelCost'),
                type: document.getElementById('fuelType'),
                station: document.getElementById('gasStation')
            };

            const deleteModeBtn = document.getElementById('deleteModeBtn');
            const deleteActions = document.getElementById('deleteActions');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

            let isDeleteMode = false;
            let inlineEditingId = null;

            // Pagination State
            let currentPage = 1;
            let rowsPerPage = 5;

            // Pagination Elements
            const rowsPerPageSelect = document.getElementById('rowsPerPage');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');

            // Load local data as fallback
            let fuelEntries = [];
            try {
                fuelEntries = JSON.parse(localStorage.getItem('fuelEntries')) || [];
            } catch (e) { fuelEntries = []; }

            renderTable();

            // --- Firestore Real-time Sync ---
            if (isFirebaseActive && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                const q = query(collection(db, "fuelEntries"), orderBy("createdAt", "desc"));
                onSnapshot(q, (snapshot) => {
                    fuelEntries = [];
                    snapshot.forEach((doc) => {
                        fuelEntries.push({ id: doc.id, ...doc.data() });
                    });
                    saveToLocal(); // Sync local cache
                    renderTable();
                });
            } else {
                console.warn("Firebase config not found or invalid. Using local storage only.");
            }

            // --- Theme ---
            const themeToggle = document.getElementById('themeToggle');
            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcons(savedTheme);

            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    const current = document.documentElement.getAttribute('data-theme');
                    const next = current === 'dark' ? 'light' : 'dark';
                    document.documentElement.setAttribute('data-theme', next);
                    localStorage.setItem('theme', next);
                    updateThemeIcons(next);
                });
            }

            function updateThemeIcons(theme) {
                sunIcon.style.display = theme === 'dark' ? 'none' : 'block';
                moonIcon.style.display = theme === 'dark' ? 'block' : 'none';
            }

            // --- Modal ---
            const fab = document.getElementById('fabAdd');
            const modal = document.getElementById('entryModal');
            const closeModalBtn = document.getElementById('closeModalBtn');

            if (fab && modal) fab.addEventListener('click', () => { modal.classList.add('open'); setTimeout(() => inputs.km.focus(), 100); });
            if (closeModalBtn && modal) closeModalBtn.addEventListener('click', () => modal.classList.remove('open'));
            window.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('open'); });

            // --- Pagination ---
            if (rowsPerPageSelect) {
                rowsPerPageSelect.addEventListener('change', (e) => {
                    rowsPerPage = parseInt(e.target.value);
                    currentPage = 1;
                    renderTable();
                });
            }

            if (prevPageBtn) prevPageBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderTable(); } });
            if (nextPageBtn) nextPageBtn.addEventListener('click', () => { const t = Math.ceil(fuelEntries.length / rowsPerPage); if (currentPage < t) { currentPage++; renderTable(); } });

            // --- Tabs ---
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    const tabId = btn.dataset.tab;
                    document.getElementById(`tab-${tabId}`).classList.add('active');
                    if (tabId === 'analytics') renderChart();
                });
            });

            // --- Data Persistence ---
            function saveToLocal() {
                localStorage.setItem('fuelEntries', JSON.stringify(fuelEntries));
            }

            async function saveData(entry) {
                if (isFirebaseActive && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                    try {
                        await addDoc(collection(db, "fuelEntries"), {
                            ...entry,
                            createdAt: serverTimestamp()
                        });
                    } catch (error) {
                        console.error("Error adding document to Firestore: ", error);
                        // Fallback: update local
                        fuelEntries.unshift(entry);
                        saveToLocal();
                        renderTable();
                    }
                } else {
                    fuelEntries.unshift(entry);
                    saveToLocal();
                    renderTable();
                }
            }

            // --- Delete Mode ---
            if (deleteModeBtn) deleteModeBtn.addEventListener('click', () => { if (inlineEditingId) { alert("Finish editing first."); return; } isDeleteMode = true; toggleDeleteMode(); });
            if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => { isDeleteMode = false; toggleDeleteMode(); });
            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', async () => {
                    const checkboxes = document.querySelectorAll('.delete-checkbox:checked');
                    if (checkboxes.length === 0) { alert('No entries selected.'); return; }
                    if (confirm(`Delete ${checkboxes.length} entries?`)) {
                        const ids = Array.from(checkboxes).map(cb => cb.value); // Values can be doc IDs (strings) or timestamps (numbers)

                        if (isFirebaseActive && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                            for (const id of ids) {
                                try {
                                    await deleteDoc(doc(db, "fuelEntries", id));
                                } catch (error) {
                                    console.error("Error deleting from Firestore:", error);
                                }
                            }
                        } else {
                            // Local fallback
                            fuelEntries = fuelEntries.filter(e => !ids.includes(e.id.toString()));
                            saveToLocal();
                            renderTable();
                        }

                        isDeleteMode = false;
                        toggleDeleteMode();
                    }
                });
            }

            function toggleDeleteMode() {
                deleteModeBtn.style.display = isDeleteMode ? 'none' : 'inline-flex';
                deleteActions.style.display = isDeleteMode ? 'flex' : 'none';
                renderTable();
            }

            // --- Form Submit ---
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const entry = {
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    km: inputs.km.value,
                    cost: Math.round(parseFloat(inputs.cost.value)),
                    type: inputs.type.value,
                    station: inputs.station.value
                };
                saveData(entry);
                form.reset();
                if (modal) modal.classList.remove('open');
                document.querySelector('[data-tab="history"]').click();
            });

            // --- Inline Edit ---
            window.startEdit = (id) => {
                if (isDeleteMode) return;
                inlineEditingId = id;
                renderTable();
                setTimeout(() => {
                    const row = document.querySelector(`tr[data-id="${id}"]`);
                    if (row) { const fi = row.querySelector('input'); if (fi) fi.focus(); }
                }, 50);
            };

            window.cancelEdit = () => { inlineEditingId = null; renderTable(); };

            window.saveEdit = async (id) => {
                const row = document.querySelector(`tr[data-id="${id}"]`);
                if (!row) return;
                const kmInput = row.querySelector('.edit-km');
                const costInput = row.querySelector('.edit-cost');
                const typeInput = row.querySelector('.edit-type');
                const stationInput = row.querySelector('.edit-station');
                if (!kmInput || !costInput || !typeInput || !stationInput) return;

                const updatedData = {
                    km: kmInput.value,
                    cost: Math.round(parseFloat(costInput.value)),
                    type: typeInput.value,
                    station: stationInput.value
                };

                if (isFirebaseActive && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE" && typeof id === 'string') {
                    try {
                        const docRef = doc(db, "fuelEntries", id);
                        await updateDoc(docRef, updatedData);
                        inlineEditingId = null;
                        // onSnapshot will trigger re-render
                    } catch (error) {
                        console.error("Error updating Firestore:", error);
                    }
                } else {
                    const index = fuelEntries.findIndex(e => e.id === id);
                    if (index !== -1) {
                        fuelEntries[index] = { ...fuelEntries[index], ...updatedData };
                        saveToLocal();
                        inlineEditingId = null;
                        renderTable();
                    }
                }
            };

            // --- CSV ---
            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn) downloadBtn.addEventListener('click', () => { if (fuelEntries.length === 0) { alert('No data yet!'); return; } downloadCSV(); });

            const loadBtn = document.getElementById('loadBtn');
            const csvInput = document.getElementById('csvInput');
            if (loadBtn && csvInput) {
                loadBtn.addEventListener('click', () => { if (confirm("Load CSV? This will merge data.\nRequired Format: Date,Time,Mileage,Cost,Fuel Type,Station")) csvInput.click(); });
                csvInput.addEventListener('change', (e) => {
                    const file = e.target.files[0]; if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => processCSV(ev.target.result);
                    reader.readAsText(file); e.target.value = '';
                });
            }

            async function processCSV(csvText) {
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) return alert('Empty CSV');
                let count = 0;
                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i]; if (!row.trim()) continue;
                    const regex = /(?:,|\n|^)("(?:(?:"")*[^"]*)*"|[^",\n]*|(?:\n|$))/g;
                    const values = []; let match;
                    while ((match = regex.exec(row))) { if (match[1] !== undefined) values.push(match[1].replace(/^"|"$/g, '').replace(/""/g, '"')); }
                    if (values.length < 6) continue;

                    const entry = {
                        date: values[0],
                        time: values[1],
                        km: values[2],
                        cost: values[3],
                        type: values[4],
                        station: values[5]
                    };

                    if (isFirebaseActive && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                        await addDoc(collection(db, "fuelEntries"), { ...entry, createdAt: serverTimestamp() });
                    } else {
                        fuelEntries.push({ id: Date.now() + i, ...entry });
                    }
                    count++;
                }
                if (count > 0) {
                    if (!isFirebaseActive || firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                        saveToLocal(); renderTable();
                    }
                    alert(`Loaded ${count} entries.`);
                }
                else alert('No valid entries found.');
            }

            function downloadCSV() {
                let csv = "Date,Time,Mileage (km),Cost ($),Fuel Type,Station\n";
                fuelEntries.forEach(e => { csv += [e.date, e.time, e.km, e.cost, e.type, `"${e.station}"`].join(",") + "\n"; });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url); link.setAttribute("download", "fuel_log.csv");
                link.style.display = 'none'; document.body.appendChild(link); link.click();
                document.body.removeChild(link); URL.revokeObjectURL(url);
            }

            // --- Render Table ---
            function renderTable() {
                const thead = document.querySelector('#historyTable thead tr');
                if (thead) {
                    thead.innerHTML = `
                        <th class="checkbox-col ${isDeleteMode ? 'show' : ''}">Select</th>
                        <th>Date</th>
                        <th>Mileage (km)</th>
                        <th>Cost ($)</th>
                        <th>Type</th>
                        <th>Station</th>
                        <th class="action-col">✎</th>`;
                }

                historyTableBody.innerHTML = '';

                if (fuelEntries.length === 0) {
                    historyTableBody.innerHTML = `<tr class="empty-state"><td colspan="${isDeleteMode ? 7 : 6}">No entries yet. Tap + to add one!</td></tr>`;
                    if (pageInfo) pageInfo.textContent = 'Page 0 of 0';
                    if (prevPageBtn) prevPageBtn.disabled = true;
                    if (nextPageBtn) nextPageBtn.disabled = true;
                    return;
                }

                const totalPages = Math.ceil(fuelEntries.length / rowsPerPage);
                if (currentPage > totalPages) currentPage = totalPages;
                if (currentPage < 1) currentPage = 1;

                const startIndex = (currentPage - 1) * rowsPerPage;
                const paginatedEntries = fuelEntries.slice(startIndex, startIndex + rowsPerPage);

                if (pageInfo) pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                if (prevPageBtn) prevPageBtn.disabled = (currentPage === 1);
                if (nextPageBtn) nextPageBtn.disabled = (currentPage === totalPages);

                paginatedEntries.forEach(entry => {
                    const row = document.createElement('tr');
                    row.dataset.id = entry.id;
                    const isEditing = (entry.id === inlineEditingId);

                    if (isEditing) {
                        row.classList.add('editing-row');
                        row.innerHTML = `
                            <td class="checkbox-col ${isDeleteMode ? 'show' : ''}"></td>
                            <td class="tc">${entry.date}<br><small style="color:#9ca3af">${entry.time}</small></td>
                            <td class="tc"><input type="number" class="edit-input edit-km" value="${entry.km}" style="width:75px;"></td>
                            <td class="tr">$<input type="number" step="1" min="0" class="edit-input edit-cost" value="${Math.round(entry.cost)}" style="width:75px;"></td>
                            <td class="tc">
                                <select class="edit-input edit-type" style="width:110px;">
                                    <option value="Regular" ${entry.type === 'Regular' ? 'selected' : ''}>Regular</option>
                                    <option value="Premium" ${entry.type === 'Premium' ? 'selected' : ''}>Premium</option>
                                </select>
                            </td>
                            <td class="tl"><input type="text" class="edit-input edit-station" value="${entry.station}" style="width:100%;"></td>
                            <td class="action-col">
                                <div style="display:flex;gap:4px;justify-content:center;">
                                    <button class="btn-icon" onclick="saveEdit('${entry.id}')" title="Save" style="color:#10b981;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                                    </button>
                                    <button class="btn-icon" onclick="cancelEdit()" title="Cancel" style="color:#ef4444;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                    </button>
                                </div>
                            </td>`;
                    } else {
                        row.innerHTML = `
                            <td class="checkbox-col ${isDeleteMode ? 'show' : ''}">
                                <input type="checkbox" class="delete-checkbox" value="${entry.id}">
                            </td>
                            <td class="tc">${entry.date}<br><small style="color:#9ca3af">${entry.time}</small></td>
                            <td class="tc">${Number(entry.km).toLocaleString()} km</td>
                            <td class="tr">$ ${Math.round(entry.cost).toLocaleString()}</td>
                            <td class="tc"><span class="badge ${entry.type.toLowerCase()}">${entry.type}</span></td>
                            <td class="tl">${entry.station}</td>
                            <td class="action-col">
                                <button class="btn-icon" onclick="startEdit('${entry.id}')" title="Edit" ${isDeleteMode ? 'disabled' : ''}>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:#6b7280;"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </button>
                            </td>`;
                    }
                    historyTableBody.appendChild(row);
                });
            }

            // --- Chart ---
            function renderChart() {
                const canvas = document.getElementById('efficiencyChart');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
                ctx.scale(dpr, dpr);
                canvas.style.width = `${rect.width}px`; canvas.style.height = `${rect.height}px`;
                ctx.clearRect(0, 0, rect.width, rect.height);

                const dataPoints = fuelEntries.map(e => ({
                    date: new Date(e.date).getTime() || e.id,
                    station: e.station,
                    efficiency: (parseFloat(e.km) / parseFloat(e.cost)) * 100
                })).sort((a, b) => a.date - b.date);

                if (dataPoints.length < 2) {
                    ctx.font = '14px Inter, sans-serif'; ctx.fillStyle = '#6b7280';
                    ctx.fillText("Need at least 2 entries to display chart", 20, 30);
                    return;
                }

                const padding = { top: 40, right: 40, bottom: 80, left: 60 };
                const chartWidth = rect.width - padding.left - padding.right;
                const chartHeight = rect.height - padding.top - padding.bottom;
                const minTime = Math.min(...dataPoints.map(d => d.date));
                const maxTime = Math.max(...dataPoints.map(d => d.date));
                const timeRange = maxTime - minTime || 1;
                const efficiencies = dataPoints.map(d => d.efficiency);
                let minEff = Math.min(...efficiencies); let maxEff = Math.max(...efficiencies);
                const rangeEff = maxEff - minEff || 100;
                minEff = Math.max(0, minEff - rangeEff * 0.1); maxEff = maxEff + rangeEff * 0.1;
                const xMap = (t) => padding.left + ((t - minTime) / timeRange) * chartWidth;
                const yMap = (e) => padding.top + chartHeight - ((e - minEff) / (maxEff - minEff)) * chartHeight;

                ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(padding.left, padding.top); ctx.lineTo(padding.left, padding.top + chartHeight); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(padding.left, padding.top + chartHeight); ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight); ctx.stroke();

                ctx.strokeStyle = '#10b981'; ctx.lineWidth = 2; ctx.beginPath();
                dataPoints.forEach((d, i) => { const x = xMap(d.date); const y = yMap(d.efficiency); i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y); });
                ctx.stroke();

                ctx.lineWidth = 2; ctx.font = '10px Inter, sans-serif'; ctx.textAlign = 'center';
                dataPoints.forEach(d => {
                    const x = xMap(d.date); const y = yMap(d.efficiency);
                    ctx.fillStyle = '#ffffff'; ctx.strokeStyle = '#059669';
                    ctx.beginPath(); ctx.arc(x, y, 5, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    ctx.save(); ctx.translate(x, padding.top + chartHeight + 15); ctx.rotate(Math.PI / 4);
                    ctx.textAlign = 'left'; ctx.fillStyle = '#374151'; ctx.fillText(d.station, 0, 0); ctx.restore();
                    ctx.fillStyle = '#10b981'; ctx.fillText(Math.round(d.efficiency), x, y - 10);
                });

                ctx.fillStyle = '#6b7280'; ctx.textAlign = 'right'; ctx.textBaseline = 'middle';
                for (let i = 0; i <= 5; i++) {
                    const v = minEff + i * (maxEff - minEff) / 5;
                    ctx.fillText(Math.round(v), padding.left - 10, yMap(v));
                }
            }

            window.addEventListener('resize', () => {
                if (document.getElementById('tab-analytics').classList.contains('active')) renderChart();
            });

            // Expose globally for onclick attributes
            window.saveEdit = saveEdit;
            window.renderChart = renderChart;
            window.renderTable = renderTable;
        });
    </script>
</body>

</html>